More nested loops, more functions
